@model IEnumerable<LogicalPantry.DTOs.UserDtos.UserDto>

@{
    ViewData["Title"] = "Manage Users";
    var tenantName = ViewBag.TenantName as string;
}

@Html.AntiForgeryToken()

<head>
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-2.0.8/b-3.0.2/b-html5-3.0.2/r-3.0.2/sc-2.4.3/sp-2.3.1/sl-2.0.3/datatables.min.css" />
    <link href="~/css/site.css" rel="stylesheet" />
    <link href="~/css/Style.css" rel="stylesheet" />
    <link href="~/css/StyleSheet.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.4/js/dataTables.js"></script>
   
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .page-header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .page-header-title {
            font-size: 1.5rem;
            margin: 0;
        }

        .container {
            padding: 1rem;
        }

        .card {
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

      
        .card-body {
            padding: 1rem;
        }

        .datatable {
            width: 100%;
            margin-top: 1rem;
        }

        table.dataTable {
            border-collapse: collapse;
            width: 100%;
        }

        table.dataTable thead th, table.dataTable tfoot th {
            background-color: #f1f1f1;
            color: #333;
            font-weight: bold;
        }

        table.dataTable tbody td {
            padding: 0.75rem;
            vertical-align: middle;
        }

        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .checkbox-wrapper-4 {
            display: flex;
            align-items: center;
        }

        .cbx {
            display: inline-block;
            cursor: pointer;
        }

        .cbx span {
            width: 1.2rem;
            height: 1.2rem;
            border-radius: 0.25rem;
            border: 2px solid #007bff;
            background-color: #fff;
        }

        .cbx input:checked + label span {
            background-color: #007bff;
            border-color: #007bff;
        }

        .deleteHref {
            color: #dc3545;
            text-decoration: none;
        }

        .deleteHref:hover {
            text-decoration: underline;
        }

      
      
        .swal-container {
            max-width: 90vw;
            max-height: 90vh;
            width: auto;
            height: auto;
            padding: 1em;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swal-popup {
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            height: auto;
            max-height: 80vh;
        }

        /* .nav-fixed #layoutSidenav #layoutSidenav_nav .sidenav {
            padding-top: 0rem;
        } */

        .container {
            padding: 5rem;
        }

        .card-header{
           font-weight : 500;
        }

       .container{
            max-width: 1050px;
       }

       .page-header > .container-fluid:first-of-type {
            display: flex;
            justify-content: center;
        }

        .nav-fixed #layoutSidenav #layoutSidenav_nav .sidenav {
            padding-top: 0rem;
        }

        .page-header-compact .page-header-content .page-header-title {
            font-size: 1.5rem;
        }

        .container-fluid {
            margin-left: 60px;
        }

        .page-header > .container-fluid:first-of-type {
            max-height: 6vh;
            display: flex;
            justify-content: center;
        }

        .page-header{
            padding-top: 1rem;
        }

            .page-header > .container-fluid:first-of-type {
                max-height: 100vh;
                /*   padding: 1rem; */
                margin-bottom: -10px;
            }

            .page-header-content >.row {
            margin-top: -10px;
            }

        #layoutSidenav_content{
            margin-bottom : -5%;
        }

        #layoutSidenav {
            margin-top: -2%;
        }

        .page-header-title {
            font-size: larger;
        }

        .page-header > .container-fluid:first-of-type {
            display: flex;
            justify-content: center;
            margin-bottom: 5px;
        }

        .mb-3 {
            margin-top: 5% !important;
        }

        .container-fluid
        {
            margin-left: 9%;
        }
    </style>
</head>

<main>
    <!-- Main page content-->
    <div class="container mt-n10">
        <div class="card mb-4">
            <div class="card-header">Manage Users</div>
            <div class="card-body">
                <div class="datatable">
                    <div id="successMessageUser" class="alert alert-success" style="display:none;">
                        Updated succesfully.
                    </div>



                    <div id="errorMessageUser" class="alert alert-danger" style="display:none;">
                        Error occured while updating user.
                    </div>
                    <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Allow</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model)
                            {
                                <tr>
                                    <td>@user.FullName</td>
                                    <td>@user.Email</td>
                                    <td class="leave-td">
                                        <div class="checkbox-wrapper-4">
                                            <input class="inp-cbx" type="checkbox" id="allowCheckbox_@user.Id" data-user-id="@user.Id" @(user.IsAllow ? "checked" : "") />
                                            <label class="cbx" for="allowCheckbox_@user.Id">
                                                <span>
                                                    <svg width="12px" height="10px">
                                                        <use xlink:href="#check-4"></use>
                                                    </svg>
                                                </span>
                                            </label>
                                            <svg class="inline-svg">
                                                <symbol id="check-4" viewBox="0 0 12 10">
                                                    <polyline points="1.5 6 4.5 9 10.5 1"></polyline>
                                                </symbol>
                                            </svg>
                                        </div>
                                    </td>
                                    @* <td class="text-center">
                                        <a href="#" class="deleteHref" onclick="deleteUser('@user.Id')">Delete</a>
                                    </td> *@

                                    <td>
                                        <button class="btn btn-datatable btn-icon btn-transparent-dark deleteHref" data-user-id="@user.Id"  @* onclick="deleteUser('@user.Id')" *@><svg class="svg-inline--fa fa-trash-can" aria-hidden="true" focusable="false" data-prefix="far" data-icon="trash-can" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M170.5 51.6L151.5 80h145l-19-28.4c-1.5-2.2-4-3.6-6.7-3.6H177.1c-2.7 0-5.2 1.3-6.7 3.6zm147-26.6L354.2 80H368h48 8c13.3 0 24 10.7 24 24s-10.7 24-24 24h-8V432c0 44.2-35.8 80-80 80H112c-44.2 0-80-35.8-80-80V128H24c-13.3 0-24-10.7-24-24S10.7 80 24 80h8H80 93.8l36.7-55.1C140.9 9.4 158.4 0 177.1 0h93.7c18.7 0 36.2 9.4 46.6 24.9zM80 128V432c0 17.7 14.3 32 32 32H336c17.7 0 32-14.3 32-32V128H80zm80 64V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16z"></path></svg><!-- <i class="fa-regular fa-trash-can"></i> Font Awesome fontawesome.com --></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.4/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.1.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    

    <script>
        $(document).ready(function () {
            var pageClass = $('body').attr('class');

            if (pageClass === 'nav-fixed') {
                $('.page-header-title').text('Manage Users');
                $('.page-header-title').addClass('custom-style');
            }
            // Initialize DataTable with custom options
            $('#dataTable').DataTable({
                paging: true,
                responsive: true,
                lengthChange: false,
                searching: false,
                columnDefs: [
                    { targets: '_all', className: 'text-left' }
                ]
            });

            $(".inp-cbx").on("change", function () {
                var checkbox = $(this);
                var userId = checkbox.data("user-id");
                var isChecked = checkbox.prop("checked");

                var tenantName = '@ViewBag.TenantName';


                $.ajax({
                    url: "/" + tenantName + "/User/UpdateUser?userId=" + userId + "&isAllow=" + isChecked,
                    type: "POST",
                    success: function (response) {
                        if (response.success) {
                            $('#successMessageUser').text('Changes saved successfully.').fadeIn().delay(2000).fadeOut();
                        } else {
                            $('#errorMessageUser').text('Error occurred while saving user.').fadeIn().delay(2000).fadeOut();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error updating user status:", error);
                    }
                });
            });

            $(".deleteHref").on("click", function (e) {
                debugger;
                e.preventDefault();
                var userId = $(this).data("user-id");
                var tenantName = '@ViewBag.TenantName';

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: "/" + tenantName + "/User/DeleteUser",
                            type: "POST",
                            data: { userId: userId },
                            success: function (response) {
                                if (response.success) {
                                    // location.reload();
                                    // if (response.success) {
                                    //     $('#successMessageUser').text('Deleteed succesfully').fadeIn().delay(2000).fadeOut();
                                    // } else {
                                    //     $('#errorMessageUser').text('Somthing went to wrong').fadeIn().delay(2000).fadeOut();
                                    // }
                                    Swal.fire(
                                        'Deleted!',
                                        'User has been deleted.',
                                        'success'
                                    ).then(() => {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire(
                                        'Error!',
                                        'There was an issue deleting the user.',
                                        'error'
                                    );
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error("Error deleting user:", error);
                            }
                        });
                    }
                });
            });
        });
    </script>
}
